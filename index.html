<!DOCTYPE html>
<head>
    <title>d3 Fishbone diagram</title>
    <meta charset="utf-8">
    <style>
        html, body{ margin: 0; padding: 0; overflow: hidden;}

        /* get it? gill? */
        *{ font-family: monospace; }

        .label-0{ font-size: 2em; }
        .label-1{ font-size: 1.5em; fill: #111; }
        .label-2{ font-size: 1em; fill: #444; }
        .label-3{ font-size: .9em; fill: #888; }
        .label-4{ font-size: .8em; fill: #aaa; }
        .label-5{ font-size: .8em; fill: #aaa; }
        .label-6{ font-size: .8em; fill: #aaa; }

        .link-0{ stroke: #000; stroke-width: 2px}
        .link-1{ stroke: #333; stroke-width: 1px}
        .link-2,
        .link-3,
        .link-4,
        .link-5,
        .link-6{ stroke: #666; stroke-width: .5px; }

        .positive { fill: green }
        .negative { fill: red }
    </style>
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.1/d3.min.js" charset="utf-8"></script>
    <script src="./d3.fishbone.js" charset="utf-8"></script>
</head>
<body>

<div style="position: absolute; left: 0; top: 0; width:25%; padding: 2px;">
    <input type="text" class="i-role-add" style="width: 100%" placeholder="Add sub item">
    <br/>
    <input type="text" class="i-role-feed" style="width: 100%" placeholder="Add comment">
</div>

<script>

    $(window).on('hashchange', function() {

        var k = ((window.location.hash || '').substr(1) || '0');

        var srcData = getData();

        var rec = srcData.filter(function (row) {
            return row.k === k;
        });

        if (rec.length === 0) {
            return [];
        }

        var path = rec[0].path + '/' + rec[0].k;

        var subX = srcData.filter(function (row) {
            return row.path.indexOf(path) === 0;
        });

        srcData = rec.concat(subX);

        drawFishbone(srcData);
    });

    $('.i-role-add').on('keypress', function (e) {
        if (e.keyCode == 13) {
            var s = $('.i-role-add').val();
            var t = s.split(':');
            addChild(t[0], t[1]);
        }
    });

    $('.i-role-feed').on('keypress', function (e) {
        if (e.keyCode == 13) {
            var s = $('.i-role-feed').val();
            var t = s.split(':');
            addFeedback(t[0], t[1], t[2]);
        }
    });

    var size = (function () {
        var g = window.document.documentElement;
        return {
            width: g.clientWidth,
            height: g.clientHeight
        };
    });

    var times = function (num) {
        var r = [];
        for (var i = 0; i < num; i++) r.push(i);
        return r;
    };

    var svg;
    var fishbone;
    var srcData;

    var feedback = [
        {"k":"6", rate: 1, comment: "Good computers", author: "Anna", date: new Date()},
        {"k":"6", rate: 1, comment: "Awesome computers", author: "Oleg", date: new Date()},
        {"k":"6", rate: -1, comment: "Bad computers", author: "Vlad", date: new Date()}
    ];

    var forceLayout = function () {
        var s = size();
        var force = fishbone.force();
        force.size([s.width, s.height]);
        force.start();
        times(250).forEach(force.tick.bind(force));
        force.stop();

        force.start();
    };

    var onDblClickBranch = function (row) {
        window.location.hash = ('#' + row.k);
    };

    var onClickBranch = function (row) {
        var childPath = row.path + '/' + row.k;
        $('.i-role-add').val(childPath + ':sub-branch');
        $('.i-role-feed').val(row.k + ':add comment here');
    };

    var addChild = function (newPath, newName) {
        srcData.push({
            name: newName,
            path: newPath,
            k: (srcData.length + 1)
        });

        drawFishbone(getData());
    };

    var addFeedback = function (k, comment, rate) {

        feedback.push({
            "k":k,
            rate: (rate == '+') ? (+1) : (-1),
            comment: comment,
            author: "anonymus",
            date: new Date()
        });

        drawFishbone(getData());
    };

    // load the data
    srcData = [
        {"name": "Quality", k: "0", "path": "."},
        {"name": "Method", k: "1", "path": "./0"},
        {"name": "Machine", k: "2", "path": "./0"},

        {"name": "Mill", k: "3", "path": "./0/2"},
        {"name": "Mixer", k: "4", "path": "./0/2"},

        {"name": "Sci-fi", k: "5", "path": "./0/1"},

        {"name": "Method 1", k: "6", "path": "./0/1/5"},
        {"name": "Method 1.1", k: "7", "path": "./0/1/5/6"},
        {"name": "Method 1.1.1", k: "8", "path": "./0/1/5/6/7"},
        {"name": "BBB", k: "9", "path": "./0/1/5/6/7/8"}
    ];

    var getData = function () {
        return JSON.parse(JSON.stringify(srcData));
    };

    var drawFishbone = function (data) {

        // create the configurable selection modifier
        fishbone = d3.fishbone(
                size(),
                function () {
                    return data;
                },
                function () {
                    return feedback;
                },
                onDblClickBranch,
                onClickBranch);

        var body = d3.select('body');
        body.select('svg').remove();
        svg = body
                .append('svg')
                .attr(size())
                .call(fishbone.defaultArrow)
                .call(fishbone);

        forceLayout();
    };

    drawFishbone(getData());

    // handle resizing the window
    d3
            .select(window)
            .on("resize", function () {
                forceLayout();
                svg.attr(size());
            });
</script>
</body>
</html>