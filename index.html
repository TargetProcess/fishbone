<!DOCTYPE html>
<head>
    <title>d3 Fishbone diagram</title>
    <meta charset="utf-8">
    <style>
        html, body{ margin: 0; padding: 0; overflow: hidden;}

        /* get it? gill? */
        *{ font-family: monospace; }

        .label-0{ font-size: 2em; }
        .label-1{ font-size: 1.5em; fill: #111; }
        .label-2{ font-size: 1em; fill: #444; }
        .label-3{ font-size: .9em; fill: #888; }
        .label-4{ font-size: .8em; fill: #aaa; }
        .label-5{ font-size: .8em; fill: #aaa; }
        .label-6{ font-size: .8em; fill: #aaa; }

        .link-0{ stroke: #000; stroke-width: 2px}
        .link-1{ stroke: #333; stroke-width: 1px}
        .link-2,
        .link-3,
        .link-4,
        .link-5,
        .link-6{ stroke: #666; stroke-width: .5px; }

        .link-positive { stroke: blue; }
        .link-negative { stroke: red; }

        .positive { fill: green; stroke: green; }
        .negative { fill: red; stroke: red; }
    </style>
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.1/d3.min.js" charset="utf-8"></script>
    <script src="./d3.fishbone.js" charset="utf-8"></script>
    <script src="./underscore-min.js" charset="utf-8"></script>
    <script src="./underscore.string.min.js" charset="utf-8"></script>
</head>
<body>

<div style="padding: 2px;width: 19%;float:left;min-height: 1000px;">
<textarea id="structure" style="width:100%; min-height: 800px;">
Problem
Problem > People
Problem > Process
Problem > Equipment
Problem > Materials
Problem > Environment
Problem > Management

Process > Cause 1
Cause 1 > Detailed cause
Cause 1 > Detailed fix > +
Process > Fix 1 > +

+Fix 1 : solve all problems : Alex
-Fix 1 : require too many time
-Fix 1 : : Misha
-Fix 1 : : Vadim
-Fix 1 : : Oleg
-Fix 1 : : Jenya
+Fix 1 : : Kostya
+Fix 1 : : Alla

Equipment > Servers
Servers > Jenkins
Servers > Statistics
Statistics > Statistics Speed
Statistics Speed > SSD > +
Statistics Speed > Cloud > +
Cloud > Statistics Price

+Statistics Price: Approve budget : Misha
-Statistics Price: No money for coffee : Jenya
</textarea>
    <button id="refresh">Refresh</button>
</div>

<div id="target" style="border: dotted 1px #000; min-height: 1000px; width: 80%;float:right"></div>

<script>

    $(window).on('hashchange', function() {

        var srcData = getData();

        var k = ((window.location.hash || '').substr(1) || srcData[0].k);

        var rec = srcData.filter(function (row) {
            return row.k === k;
        });

        if (rec.length === 0) {
            return [];
        }

        var path = rec[0].path + '/' + rec[0].k;

        var subX = srcData.filter(function (row) {
            return row.path.indexOf(path) === 0;
        });

        srcData = rec.concat(subX);

        drawFishbone(srcData);
    });

    $('#refresh').on('click', function (e) {
        parseSrc();
        drawFishbone(getData());
    });

    var size = (function () {
        var g = window.document.documentElement;
        return {
            width: $('#target').width(),
            height: g.clientHeight
        };
    });

    var times = function (num) {
        var r = [];
        for (var i = 0; i < num; i++) r.push(i);
        return r;
    };

    var svg;
    var fishbone;
    var srcData = [];
    var feedback = [];

    function parseSrc() {

        var isComment = function (str) {
            var s = str.charAt(0);
            return ((s === '+') || (s === '-'));
        };

        var isNotComment = function (str) {
            return !isComment(str);
        };

        var v = $('#structure').val();
        var t = v.split('\n');
        var h = {};
        var s = t.filter(isNotComment);
        srcData = s.reduce(function (memo, str, i) {
                    var tokens = str
                            .split('>')
                            .map(function (t) {
                                return t.trim();
                            })
                            .filter(_.identity);

                    if (i === 0 && tokens.length === 1) {

                        var k = tokens[0];
                        h[k] = k;

                        return memo.concat({
                            "name": k,
                            "k": k,
                            "path": k,
                            "rate": -1
                        });
                    }

                    if (tokens.length < 2) {
                        // just skip it
                        return memo;
                    }

                    var row = {
                        "name": tokens[1],
                        "k": tokens[1],
                        "path": h[tokens[0]] + "/" + tokens[0],
                        rate: (tokens[2] === '+' ? (+1) : (-1))
                    };

                    h[row.k] = row.path;

                    return memo.concat(row);
                },
                []);

        feedback = t
                .filter(isComment)
                .reduce(function (memo, str) {
                    var tokens = str
                            .split(':')
                            .map(function (t) {
                                return t.trim();
                            })
                            .filter(_.identity);

                    var sign = tokens[0].charAt(0);
                    var k = tokens[0].substr(1);

                    return memo.concat({
                        "k":k,
                        rate: sign === '+' ? (+1) : (-1),
                        comment: tokens[1],
                        author: tokens[2],
                        date: new Date()
                    });
                },
                []);
    }

    parseSrc();

    var forceLayout = function () {
        var s = size();
        var force = fishbone.force();
        force.size([s.width, s.height]);
        force.start();
        times(250).forEach(force.tick.bind(force));
        force.stop();

        force.start();
    };

    var onDblClickBranch = function (row) {
        window.location.hash = ('#' + row.k);
    };

    var getData = function () {
        return JSON.parse(JSON.stringify(srcData));
    };

    var drawFishbone = function (data) {

        // create the configurable selection modifier
        fishbone = d3.fishbone(
                size(),
                function () {
                    return data;
                },
                function () {
                    return feedback;
                },
                onDblClickBranch,
                function () {});

        var target = d3.select('#target');
        target.select('svg').remove();
        svg = target
                .append('svg')
                .attr(size())
                .call(fishbone.defaultArrow)
                .call(fishbone);

        forceLayout();
    };

    drawFishbone(getData());

    // handle resizing the window
    d3
            .select(window)
            .on("resize", function () {
                forceLayout();
                svg.attr(size());
            });
</script>
</body>
</html>